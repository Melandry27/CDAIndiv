name: Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.EC2_PORT }} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "ðŸ“‚ Contenu de /home/ubuntu avant clonage :"
            ls -la /home/ubuntu

            cd /home/ubuntu

            if [ ! -d "CDAIndiv/.git" ]; then
              echo "ðŸ“¥ Cloning repository into CDAIndiv..."
              rm -rf CDAIndiv
              git clone https://github.com/melandry27/CDAIndiv.git CDAIndiv
            else
              echo "ðŸ” Pulling latest changes in CDAIndiv..."
              git -C CDAIndiv pull origin main
            fi

            cd CDAIndiv

            echo "ðŸ“ Contenu de CDAIndiv :"
            ls -la

            echo "ðŸ”§ Installing Node.js and npm if not present..."
            command -v npm >/dev/null 2>&1 || curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - && sudo apt-get install -y nodejs

            echo "ðŸ“¦ Installing dependencies..."
            cd API && npm install && npm run build && cd ..
            cd BACKOFFICE && npm install && npm run build && cd ..

            echo "ðŸš€ Ensuring PM2 is available..."
            command -v pm2 >/dev/null 2>&1 || sudo npm install -g pm2

            echo "ðŸ”„ Restarting apps with PM2..."
            pm2 stop all || true

            cd API
            pm2 start dist/server.js --name cesizen-api
            cd ..

            cd BACKOFFICE
            pm2 start npx --name cesizen-back -- vite preview
            cd ..

            echo "âœ… Deploy complete"
          EOF
