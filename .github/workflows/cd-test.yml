name: Deploy to Test Environment

on:
  push:
    branches: [test]

jobs:
  deploy-test:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Deploy Test Stack with PM2
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.EC2_PORT }} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            echo "ðŸ“ Switch to test repo"
            cd ~/cesizen-test || {
              echo "Cloning repo..."
              git clone -b test https://github.com/${{ github.repository }} cesizen-test
              cd cesizen-test
            }

            git checkout test
            git pull origin test

            echo "ðŸ“¦ Build images locally"
            docker build -f API/Dockerfile.test -t cesizen-api:test ./API
            docker build -f BACKOFFICE/Dockerfile.test -t cesizen-backoffice:test ./BACKOFFICE
            docker build -f APP/Dockerfile.test -t cesizen-app:test ./APP

            echo "ðŸ›  Migrate DB (PostgreSQL local on 5433 assumed running)"
            docker run --rm \
              --network host \
              -e DATABASE_URL=postgresql://postgres:postgres@localhost:5433/cesizen_test \
              -e JWT_SECRET=test-secret \
              cesizen-api:test \
              npx prisma migrate deploy

            echo "â™»ï¸ Stop previous PM2 apps"
            pm2 delete cesizen-api-test || true
            pm2 delete cesizen-backoffice-test || true
            pm2 delete cesizen-app-test || true

            echo "ðŸš€ Start containers via PM2"

            pm2 start docker --name cesizen-api-test -- \
              run -p 3001:3000 \
              -e DATABASE_URL=postgresql://postgres:postgres@localhost:5433/cesizen_test \
              -e JWT_SECRET=test-secret \
              cesizen-api:test

            pm2 start docker --name cesizen-backoffice-test -- \
              run -p 4175:4173 \
              -e VITE_API_URL=http://localhost:3001/api \
              cesizen-backoffice:test

            pm2 start docker --name cesizen-app-test -- \
              run -p 8082:80 \
              cesizen-app:test

            echo "ðŸ’¾ Saving PM2 processes"
            pm2 save

            echo "âœ… Test env ready via PM2"
          EOF
