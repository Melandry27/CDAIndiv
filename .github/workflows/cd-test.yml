name: Deploy to Test Environment

on:
  push:
    branches: [test]

jobs:
  deploy-test:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}

      - name: Deploy Test Stack on EC2
        run: |
          ssh -o StrictHostKeyChecking=no -p ${{ secrets.EC2_PORT }} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << EOF
            set -e

            echo "📁 Switching to test environment"
            cd ~/cesizen-test || {
              echo "❌ Dossier ~/cesizen-test introuvable. Clonage..."
              git clone -b test https://github.com/${{ github.repository }} cesizen-test
              cd cesizen-test
            }

            echo "🔁 Pulling latest test branch"
            git checkout test
            git pull origin test

            echo "🐘 Deploying test PostgreSQL container..."
            docker volume create cesizen-db-test || true
            docker stop cesizen-postgres-test || true && docker rm cesizen-postgres-test || true

            docker run -d \
              --name cesizen-postgres-test \
              -e POSTGRES_USER=postgres \
              -e POSTGRES_PASSWORD=postgres \
              -e POSTGRES_DB=cesizen_test \
              -v cesizen-db-test:/var/lib/postgresql/data \
              -p 5433:5432 \
              postgres:15

            echo "⏳ Waiting for test DB to be ready..."
            sleep 10

            echo "🐳 Pulling test images..."
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cesizen-api:test
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cesizen-backoffice:test
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/cesizen-app:test

            echo "🛠 Running Prisma Migrate on test DB..."
            docker run --rm \
              --network host \
              -e DATABASE_URL=postgresql://postgres:postgres@localhost:5433/cesizen_test \
              -e JWT_SECRET=test-secret \
              ${{ secrets.DOCKERHUB_USERNAME }}/cesizen-api:test \
              npx prisma migrate deploy

            echo "♻️ Restarting test containers..."

            docker stop cesizen-api-test || true && docker rm cesizen-api-test || true
            docker run -d \
              --name cesizen-api-test \
              -p 3001:3000 \
              -e DATABASE_URL=postgresql://postgres:postgres@localhost:5433/cesizen_test \
              -e JWT_SECRET=test-secret \
              ${{ secrets.DOCKERHUB_USERNAME }}/cesizen-api:test

            docker stop cesizen-backoffice-test || true && docker rm cesizen-backoffice-test || true
            docker run -d \
              --name cesizen-backoffice-test \
              -p 4175:4173 \
              -e VITE_API_URL=http://localhost:3001/api \
              ${{ secrets.DOCKERHUB_USERNAME }}/cesizen-backoffice:test

            docker stop cesizen-app-test || true && docker rm cesizen-app-test || true
            docker run -d \
              --name cesizen-app-test \
              -p 8082:80 \
              ${{ secrets.DOCKERHUB_USERNAME }}/cesizen-app:test

            echo "✅ Test environment deployed with pulled images!"
          EOF
